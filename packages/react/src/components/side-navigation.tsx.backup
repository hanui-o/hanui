'use client';

import React from 'react';
import * as Accordion from '@radix-ui/react-accordion';
import { cn } from '../lib/utils';

/**
 * 사이드 네비게이션 링크 아이템 (3/4단계)
 */
export interface SideNavLink {
  /** 링크 라벨 */
  label: string;
  /** 링크 URL */
  href?: string;
  /** 활성화 상태 */
  active?: boolean;
  /** 하위 링크 (4단계) */
  children?: SideNavLink[];
}

/**
 * 사이드 네비게이션 섹션 (2단계)
 */
export interface SideNavSection {
  /** 섹션 라벨 */
  label: string;
  /** 섹션 URL (선택사항, 토글 버튼용) */
  href?: string;
  /** 활성화 상태 */
  active?: boolean;
  /** 하위 링크 또는 중첩 섹션 */
  children?: SideNavLink[];
}

/**
 * 사이드 네비게이션 Props
 */
export interface SideNavigationProps extends React.HTMLAttributes<HTMLElement> {
  /** 네비게이션 제목 (1단계) */
  title: string;
  /** 네비게이션 섹션 (2단계) */
  sections: SideNavSection[];
  /** 추가 CSS 클래스 */
  className?: string;
}

/**
 * 사이드 네비게이션 컴포넌트
 *
 * KRDS 표준을 따르는 다단계 사이드 네비게이션
 * - 최대 4단계 깊이 지원
 * - 토글 버튼으로 확장 가능한 섹션
 * - 활성 상태 표시
 * - WCAG 2.1 / KWCAG 2.2 준수
 */
export function SideNavigation({
  title,
  sections,
  className = '',
  ...props
}: SideNavigationProps) {
  // 활성 상태 기반으로 기본 열림 항목 계산
  const defaultValue = sections
    .map((section, index) =>
      section.active || section.children?.some((child) => child.active)
        ? `section-${index}`
        : ''
    )
    .filter(Boolean);

  return (
    <nav
      className={cn('w-full max-w-[296px] py-10 pr-10 bg-white', className)}
      aria-labelledby="side-nav-title"
      {...props}
    >
      {/* 1단계: 제목 (nav의 레이블로 사용, 페이지 heading 구조와 분리) */}
      <div
        id="side-nav-title"
        className="px-2 pb-4 m-0 border-b border-krds-gray-50 text-2xl font-bold leading-[1.4] text-krds-gray-90"
      >
        {title}
      </div>

      {/* 2단계: 섹션 */}
      <ul role="menubar" className="list-none p-0 m-0">
        <Accordion.Root type="multiple" defaultValue={defaultValue}>
          {sections.map((section, sectionIndex) => {
            const isActive =
              section.active || section.children?.some((child) => child.active);
            const hasChildren = section.children && section.children.length > 0;
            const value = `section-${sectionIndex}`;

            return (
              <Accordion.Item
                key={sectionIndex}
                value={value}
                className={cn('relative', isActive && 'active')}
              >
                {hasChildren ? (
                  <>
                    {/* 하위 메뉴가 있는 섹션의 토글 버튼 */}
                    <Accordion.Header asChild>
                      <Accordion.Trigger asChild>
                        <button
                          type="button"
                          className={cn(
                            // 기본 버튼 스타일
                            'flex items-center justify-between w-full px-2 pt-4 pb-2 border-0 border-b border-krds-gray-20 bg-transparent',
                            'text-[17px] font-normal leading-[1.5] text-krds-gray-90 text-left no-underline cursor-pointer',
                            'transition-all duration-200 ease-in-out',
                            // 토글 버튼 스타일
                            'relative font-bold',
                            // 하단 밑줄 효과
                            'before:content-[""] before:inline-flex before:absolute before:bottom-[-1px] before:left-0 before:w-0 before:h-[3px] before:bg-[#063a74] before:transition-all before:duration-[400ms] before:ease-in-out',
                            // 호버
                            'hover:bg-krds-primary-5 hover:before:w-full',
                            // 포커스
                            'focus-visible:outline focus-visible:outline-2 focus-visible:outline-krds-blue-60 focus-visible:outline-offset-[-2px]',
                            // 활성 상태
                            isActive &&
                              'border-none mb-1',
                            // 셰브론 아이콘
                            'after:content-[""] after:inline-block after:w-5 after:h-5 after:flex-shrink-0',
                            'after:bg-[url("https://www.krds.go.kr/resources/img/component/icon/ico_angle.svg")]',
                            'after:bg-no-repeat after:bg-center after:bg-contain',
                            'after:transition-transform after:duration-200 after:ease-in-out',
                            'data-[state=open]:after:rotate-180'
                          )}
                          role="menuitem"
                        >
                          {section.label}
                        </button>
                      </Accordion.Trigger>
                    </Accordion.Header>

                    {/* 하위 메뉴 */}
                    <Accordion.Content
                      className={cn(
                        'overflow-hidden',
                        'data-[state=open]:animate-slideDown',
                        'data-[state=closed]:animate-slideUp'
                      )}
                    >
                      <ul role="menu" className="list-none p-0 m-0">
                        {section.children!.map((child, childIndex) => {
                          const hasGrandChildren =
                            child.children && child.children.length > 0;
                          const childValue = `child-${sectionIndex}-${childIndex}`;

                          // 3단계에 하위가 있으면 중첩 Accordion 사용
                          if (hasGrandChildren) {
                            const isChildActive =
                              child.active ||
                              child.children?.some((c) => c.active);

                            return (
                              <li key={childIndex} role="none">
                                <Accordion.Root
                                  type="multiple"
                                  defaultValue={
                                    isChildActive ? [childValue] : []
                                  }
                                >
                                  <Accordion.Item
                                    value={childValue}
                                    className={cn(
                                      'relative',
                                      isChildActive && 'active'
                                    )}
                                  >
                                    <Accordion.Header asChild>
                                      <Accordion.Trigger asChild>
                                        <button
                                          type="button"
                                          className={cn(
                                            // 기본 버튼 스타일
                                            'flex items-center gap-2 w-full py-2 px-4 border-0 bg-transparent',
                                            'text-[17px] font-normal leading-[1.5] text-krds-gray-90 text-left no-underline cursor-pointer',
                                            'transition-all duration-200 ease-in-out rounded-md',
                                            // 3단계 토글 버튼
                                            'relative',
                                            // 불릿 포인트
                                            'before:content-["•"] before:inline-block',
                                            // 호버
                                            'hover:bg-krds-primary-5',
                                            // 셰브론 아이콘
                                            'after:content-[""] after:inline-block after:w-5 after:h-5 after:flex-shrink-0 after:ml-auto',
                                            'after:bg-[url("https://www.krds.go.kr/resources/img/component/icon/ico_angle.svg")]',
                                            'after:bg-no-repeat after:bg-center after:bg-contain',
                                            'after:transition-transform after:duration-200 after:ease-in-out',
                                            'data-[state=open]:after:rotate-180'
                                          )}
                                          role="menuitem"
                                          aria-haspopup="true"
                                        >
                                          {child.label}
                                        </button>
                                      </Accordion.Trigger>
                                    </Accordion.Header>

                                    <Accordion.Content
                                      className={cn(
                                        'overflow-hidden',
                                        'data-[state=open]:animate-slideDown',
                                        'data-[state=closed]:animate-slideUp'
                                      )}
                                    >
                                      {/* 3단계 제목 버튼 (시각적 전용, KRDS HTML 기준) */}
                                      <button
                                        type="button"
                                        className="block w-full py-2 px-4 text-[17px] font-medium leading-[1.5] text-krds-gray-90 text-left bg-transparent border-0 cursor-default"
                                      >
                                        {child.label}
                                      </button>
                                      <ul
                                        role="menu"
                                        className="list-none p-0 m-0"
                                      >
                                        {child.children!.map(
                                          (grandChild, grandChildIndex) => (
                                            <li
                                              key={grandChildIndex}
                                              role="none"
                                            >
                                              <a
                                                href={grandChild.href}
                                                className={cn(
                                                  'flex items-center justify-between w-full py-3 px-3 pl-16 border-0 bg-transparent',
                                                  'text-[17px] font-normal leading-[1.5] text-krds-gray-90 text-left no-underline cursor-pointer',
                                                  'relative',
                                                  // 불릿 포인트
                                                  'before:content-["•"] before:absolute before:left-10 before:text-2xl before:text-krds-gray-60',
                                                  // 호버
                                                  'hover:bg-krds-primary-5',
                                                  // 활성 상태
                                                  grandChild.active &&
                                                    'font-bold text-krds-blue-60 underline before:text-krds-blue-60'
                                                )}
                                                role="menuitem"
                                                aria-current={
                                                  grandChild.active
                                                    ? 'page'
                                                    : undefined
                                                }
                                              >
                                                {grandChild.label}
                                              </a>
                                            </li>
                                          )
                                        )}
                                      </ul>
                                    </Accordion.Content>
                                  </Accordion.Item>
                                </Accordion.Root>
                              </li>
                            );
                          }

                          return (
                            <li
                              key={childIndex}
                              className={cn(
                                'relative',
                                child.active && 'active'
                              )}
                              role="none"
                            >
                              <a
                                href={child.href}
                                className={cn(
                                  'flex items-center gap-2 w-full py-2 px-4 border-0 bg-transparent',
                                  'text-[17px] font-normal leading-[1.5] text-krds-gray-90 text-left no-underline cursor-pointer',
                                  'relative',
                                  // 불릿 포인트
                                  'before:content-["•"] before:inline-block',
                                  // 호버
                                  'hover:bg-krds-primary-5',
                                  // 활성 상태
                                  child.active &&
                                    'font-bold text-krds-blue-60 before:text-krds-blue-60'
                                )}
                                aria-current={child.active ? 'page' : undefined}
                                role="menuitem"
                              >
                                {child.label}
                              </a>
                            </li>
                          );
                        })}
                      </ul>
                    </Accordion.Content>
                  </>
                ) : (
                  /* 하위 메뉴가 없는 섹션 (단순 링크) */
                  <a
                    href={section.href}
                    className={cn(
                      'flex items-center justify-between w-full py-3 px-3 border-0 border-b border-krds-gray-20 bg-transparent',
                      'text-[17px] font-normal leading-[1.5] text-krds-gray-90 text-left no-underline cursor-pointer',
                      'transition-all duration-200 ease-in-out',
                      // 하단 밑줄 효과
                      'relative before:content-[""] before:inline-flex before:absolute before:bottom-[-1px] before:left-0 before:w-0 before:h-[3px] before:bg-[#063a74] before:transition-all before:duration-[400ms] before:ease-in-out',
                      // 호버
                      'hover:bg-krds-gray-10 hover:before:w-full',
                      // 포커스
                      'focus-visible:outline focus-visible:outline-2 focus-visible:outline-krds-blue-60 focus-visible:outline-offset-[-2px]',
                      // 활성 상태
                      section.active && 'font-bold text-krds-blue-60'
                    )}
                    aria-current={section.active ? 'page' : undefined}
                    role="menuitem"
                  >
                    {section.label}
                  </a>
                )}
              </Accordion.Item>
            );
          })}
        </Accordion.Root>
      </ul>
    </nav>
  );
}

/**
 * 샘플 사이드 네비게이션 데이터
 */
export const SAMPLE_SIDE_NAVIGATION: SideNavSection[] = [
  {
    label: '2Depth-menu',
    children: [
      {
        label: '3Depth-menu',
        children: [
          { label: '4Depth', href: '#' },
          { label: '4Depth', href: '#' },
          { label: '4Depth', href: '#' },
        ],
      },
      { label: '3Depth-link', href: '#' },
      { label: '3Depth-link', href: '#' },
    ],
  },
  {
    label: '2Depth-menu',
    children: [
      {
        label: '3Depth-menu',
        children: [
          { label: '4Depth', href: '#' },
          { label: '4Depth', href: '#' },
          { label: '4Depth', href: '#' },
        ],
      },
      { label: '3Depth-link', href: '#' },
      { label: '3Depth-link', href: '#' },
    ],
  },
  {
    label: '2Depth-menu',
    children: [
      {
        label: '3Depth-menu',
        children: [
          { label: '4Depth', href: '#' },
          { label: '4Depth', href: '#' },
          { label: '4Depth', href: '#' },
        ],
      },
      { label: '3Depth-link', href: '#' },
      { label: '3Depth-link', href: '#' },
    ],
  },
];
